{% extends "splunkdj:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}Treemap - Web Framework Toolkit{% endblock title %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css">
<link rel="stylesheet" href="{{STATIC_URL}}splunk_wftoolkit/custom.css"/>

<style type="text/css">
.chart {
  display: block;
  margin: auto;
  margin-top: 40px;
}

text {
  font-size: 11px;
}

rect {
  fill: none;
}
</style>
{% endblock css %}

{% block content %}
<div class="dashboard-body container-fluid main-section-body component-page" data-role="main">
    <div class="row">
        <div class="span12 dashboard-header clearfix">
            <h2>Treemap</h2>
        </div>
    </div>
    <div class="dashboard-row">
        <div id="hook"></div>
    </div>

{% endblock content %}

{% block managers %}
    {% searchmanager id="search1" search="index=_internal | head 30" %}
{% endblock managers %}

{% block js %}

{{block.super}}
<script>
    require(
        [
        'jquery',
        'underscore',
        'splunkjs/mvc/searchmanager',
        'splunkjs/mvc/tableview',
        'splunk_wftoolkit/components/d3/d3',
        'splunkjs/ready!',
        ], 
        function(
                $, 
                _,
                SearchManager,
                TableView,
                d3,
                mvc
    ) {
        var w = 1280 - 80,
        h = 800 - 180,
        x = d3.scale.linear().range([0, w]),
        y = d3.scale.linear().range([0, h]),
        color = d3.scale.category20c(),
        root,
        node;

        var treemap = d3.layout.treemap()
            .round(false)
            .size([w, h])
            .sticky(true)
            .value(function(d) { return d.size; });

        var svg = d3.select("#hook").append("div")
            .attr("class", "chart")
            .style("width", w + "px")
            .style("height", h + "px")
          .append("svg:svg")
            .attr("width", w)
            .attr("height", h)
          .append("svg:g")
            .attr("transform", "translate(.5,.5)");

        var data = getData();
        var staticUrl = '{{STATIC_URL}}';
        node = root = data;

        var nodes = treemap.nodes(root)
            .filter(function(d) { return !d.children; });

        var cell = svg.selectAll("g")
            .data(nodes)
          .enter().append("svg:g")
            .attr("class", "cell")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .on("click", function(d) { return zoom(node == d.parent ? root : d.parent); });

        cell.append("svg:rect")
            .attr("width", function(d) { 
                return d.dx - 1; })
            .attr("height", function(d) { return d.dy - 1; })
            .style("fill", function(d) { return color(d.parent.name); });

        cell.append("svg:text")
            .attr("x", function(d) { return d.dx / 2; })
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .text(function(d) { return d.name; })
            .style("opacity", function(d) { d.w = this.getComputedTextLength(); return d.dx > d.w ? 1 : 0; });

        d3.select(window).on("click", function() { zoom(root); });

        d3.select("select").on("change", function() {
          treemap.value(this.value == "size" ? size : count).nodes(root);
          zoom(node);
        });
        
        function size(d) {
          return d.size;
        }

        function count(d) {
          return 1;
        }

        function zoom(d) {
          var kx = w / d.dx, ky = h / d.dy;
          x.domain([d.x, d.x + d.dx]);
          y.domain([d.y, d.y + d.dy]);

          var t = svg.selectAll("g.cell").transition()
              .duration(d3.event.altKey ? 7500 : 750)
              .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

          t.select("rect")
              .attr("width", function(d) { return kx * d.dx - 1; })
              .attr("height", function(d) { return ky * d.dy - 1; })

          t.select("text")
              .attr("x", function(d) { return kx * d.dx / 2; })
              .attr("y", function(d) { return ky * d.dy / 2; })
              .style("opacity", function(d) { return kx * d.dx > d.w ? 1 : 0; });

          node = d;
          d3.event.stopPropagation();
        }

        function getData() {
            return {
                "name": "Node usage",
                "children": [
                    {"name": "sid: 83", "size": 12},
                    {"name": "sid: 10", "size": 37},
                    {"name": "sid: 42",
                        "children": [
                            {"name": "sid: 555", "size": 40},
                            {"name": "sid: 556", "size": 43},
                            {"name": "sid: 556", "size": 7}
                        ]
                    },
                    {"name": "sid: 97", "size": 47},
                    {"name": "sid: 101", "size": 1},
                    {"name": "sid: 3", "size": 17}
                ]
            }
        }
    });
       
    </script>
{% endblock js %}
